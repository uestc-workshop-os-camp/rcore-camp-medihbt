# 实验报告2: rCore OS 的分页内存管理

## 新增内容：

- 增加了 `copy_to_user`, `copy_obj_to_user<T>` 等在用户空间与内核空间之间拷贝内存的工具函数.
- 实现了 `mmap` `munmap` 系统调用; 使用 `copy_obj_to_user<T>` 改进了 `get_time` 等系统调用, 使其可以在分页系统上工作.
- 在不改变 `TaskManager` 权限的情况下提供了读写当前进程 TCB 的函数 `read_current_tcb` 等.

## 问答

1. 请列举 SV39 页表页表项的组成，描述其中的标志位有何作用？

- [0] = V (valid) 页表是否合法
- [1:3] = RWX 读写执行权限
- [4] = U 用户态可访问
- [5] = G 页面是不是全局的
- [6] = A 上次清零后, 页面是否被访问过
- [7] = D 上次清零后，该页面是否被修改过(脏页)
- [8:9] = RSW 预留
- [10:18] = PPN0 物理页号 0 段
- [19:27] = PPN1
- [28:53] = PPN2
- [54:63] = 预留

2. 缺页

1) 请问哪些异常可能是缺页导致的？

指令缺页 -- scause = 12
读缺页   -- scause = 13
写/原子操缺页 -- scause = 15

2) 相关寄存器

scause: 描述缺页异常原因
satp: 页表项相关
stval: 相关地址

3) Lazy 策略的好处

减少不必要的分配，节省时间与空间开销; 根据 Lazy 策略还能发展出 Fork 时 CoW 拷贝页表等节省空间和时间的做法

4) 处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存 (估算数量级即可)？

10G / 512 + 10G / 256K + 10G / 128M ≅ 21 MB

5) 如何才能实现 Lazy 策略，缺页时又如何处理？

对于 mmap 等需要分配页面的操作, 可以在页表之外另建一张表(例如区间树)来处理一个页面区间是否被分配; 或者建一个队列来存储没有分配的页面区间. 当缺页中断发生时查询页面分配表，若该页面在页面分配表中有表项，则在页表中进行实际的页面分配操作.

对于一定初始化为 0 的页面, 可以把这些虚拟页全部分配到同一个初始化为 0 的只读页面上。这样只有写缺页异常发生，当写缺页异常发生时才实际分配页面.

对于 fork() 这种需要拷贝大量内存的场景，可以只拷贝页表并把新页表的所有页面设为只读. 当写缺页异常发生时，那些实际(按程序段)能写的页面再做实际的拷贝操作.

6) 缺页的另一个常见原因是 swap 策略，也就是内存页面可能被换到磁盘上了，导致对应页面失效。此时页面失效如何表现在页表项(PTE)上？

PTE项的 V 置 0 即可.

3. KPTI 与传统页表

1) 在单页表情况下，如何更换页表？

任务切换时让 satp 跟着切换, 就换到了新页表.

2) 单页表情况下，如何控制用户态无法访问内核页面？

把内核态的 U 标志位置 0 即可.

3) 单页表有何优势？

同一任务在用户态和内核态间切换不需要换页表，开销小；内存占用少于双页表

4) 双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表?

任务间切换和任务内特权级切换都要换页表.

单页表操作系统: 只要在任务间切换时换页表即可.

## 反馈

这个章节难度相比前几章高得多，不仅要钻透 SV39 分页机制、rCore OS 页面管理机制，还要大量阅读源码——尤其是涉及 mmap / munmap 边界情况的处理，甚至还要读测试用例的源码才能搞清楚到底该怎么处理。不知道这个项目的注释能不能再详细一些，要是有中文注释的话那更好了。

## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

> 文心一言: 学习 RISC-V 分页机制，辅助理解内存子系统几类页号的层层封装

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

> RvBook，MIT 6.S081 Lecture 7: Page Faults

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。